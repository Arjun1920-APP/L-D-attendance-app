<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback Form</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="card">
  <div class="header">
    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="Logo">
    <h1>Learning & Development</h1>
    <h2>{{ session }}</h2>
  </div>

  <div id="formContainer">
    <!-- Step 1: Personal Info -->
    <div class="step step-personal">
      <div class="form-group">
        <label class="form-label">Name*</label>
        <input type="text" id="name" class="form-control" placeholder="Full name" required>
      </div>
      <div class="form-group">
        <label class="form-label">Ambit Email*</label>
        <input type="email" id="email" class="form-control" placeholder="Ambit email" required>
      </div>
      <div class="form-group">
        <label class="form-label">Mobile*</label>
        <input type="text" id="phone" class="form-control" placeholder="Mobile no." required>
      </div>
      <input type="hidden" id="session" value="{{session}}">
      <input type="hidden" id="session_id" value="{{ session_id }}">
      <input type="hidden" id="session_date" value="{{ session_date }}">
      <button class="submit-btn" onclick="startFeedback()"> Next &raquo; </button>
    </div>

    <!-- Step 2: Feedback Questions -->
    <div class="step step-feedback">
      <div class="progress mb-2">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <h5 id="questionText"></h5>
      <button class="option-btn" onclick="selectAnswer(0)"></button>
      <button class="option-btn" onclick="selectAnswer(1)"></button>
      <button class="option-btn" onclick="selectAnswer(2)"></button>
      <button class="option-btn" onclick="selectAnswer(3)"></button>
      <button class="option-btn" onclick="selectAnswer(4)"></button>

    </div>
  </div>
</div>

<script>
let answers = {};
let currentStep = 0;
let questions = [
  { q: "Content was relevant to my role", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "Context and Content gave me opportunities to reflect ", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "Facilitator was knowledgeable and had expertise on the subject", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "Facilitator communicated with clarity", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "Facilitator was able to engage with the participants and gave us ample opportunity to ask questions", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "Likelihood of applying what I learned", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "Overall satisfaction with the program", options: ["Excellent","Very Good","Good","Fair","Poor"], type: "choice" },
  { q: "I would recommend this program to a colleague", options: ["Yes","Maybe","No"], type: "choice" },
  { q: "Please share two takeaways from the Program which I will apply back to work", type: "text" },
  { q: "Please provide any additional comments or suggestions for the program", type: "text" }
];

// Start Feedback - called when user clicks Next on personal info
function startFeedback() {
    let name = document.getElementById('name').value.trim();
    let email = document.getElementById('email').value.trim();
    let phone = document.getElementById('phone').value.trim();
    let sessionName = document.getElementById('session').value;

    if(!name || !email || !phone){ 
        alert("Fill all fields"); 
        return; 
    }
let nextBtn = document.querySelector('.submit-btn');
    nextBtn.disabled = true;
    nextBtn.innerText = "Please Wait...";
  answers.name = name;
  answers.email = email;
  answers.phone = phone;
  answers.session_id = document.getElementById('session_id').value;
  answers.session_date = document.getElementById('session_date').value;
  answers.session_name = document.getElementById('session').value; // your existing session display

  // --- NEW: Perform server-side email validation ---
    fetch("/validate_email", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            email: email, 
            session_id: answers.session_id
        })
    }).then(res => res.json())
      .then(data => {
          // Re-enable the button regardless of outcome
          nextBtn.disabled = false;
          nextBtn.innerText = "Next »"; 

          if(data.status === "success"){
              // Email is valid (found on the list or validation passed)
              document.querySelector('.step-personal').style.display = "none";
              let feedbackStep = document.querySelector('.step-feedback');
              feedbackStep.style.display = "block";
              document.querySelector('.progress').style.display = "block";

              currentStep = 0;
              showQuestion();
          } else {
              // Email is NOT valid (not found on the list)
              alert("Error: " + data.message);
          }
      }).catch(err => {
          // Handle network errors
          nextBtn.disabled = false;
          nextBtn.innerText = "Next »";
          alert("A network error occurred during email validation.");
      });


    currentStep = 0;
    showQuestion();
}

// Show current question
function showQuestion() {
    let q = questions[currentStep];
    document.getElementById('questionText').innerText = q.q;
    let buttons = document.querySelectorAll('.option-btn');

    // Reset all MCQ buttons first
    buttons.forEach(btn => {
        btn.style.display = "none";               // hide initially
        btn.style.backgroundColor = "#fff";       // white background
        btn.style.color = "#C0392B";              // red text
        btn.style.borderColor = "#C0392B";        // red border
        btn.classList.remove("selected");         // remove selection
        btn.onmouseenter = null;                  // remove old hover
        btn.onmouseleave = null;
    });

    if (q.type === "choice") {
        // Show MCQ buttons
        buttons.forEach((btn, i) => {
            if (q.options[i]) {
                btn.style.display = "inline-block";
                btn.innerText = q.options[i];
                btn.disabled = false;

                // Hover effect
                btn.onmouseenter = () => { 
                    btn.style.backgroundColor = "#E74C3C"; 
                    btn.style.color = "#fff"; 
                }
                btn.onmouseleave = () => { 
                    if(!btn.classList.contains("selected")) {
                        btn.style.backgroundColor = "#fff"; 
                        btn.style.color = "#C0392B"; 
                    }
                }

                // Click handler to select answer
                btn.onclick = () => {
                    // Mark selected
                    buttons.forEach(b => {
                        b.classList.remove("selected");
                        b.style.backgroundColor = "#fff";
                        b.style.color = "#C0392B";
                    });
                    btn.classList.add("selected");
                    btn.style.backgroundColor = "#E74C3C";
                    btn.style.color = "#fff";

                    selectAnswer(i); // move to next question
                }
            }
        });

        // Hide text input/button if exists
        let textInput = document.getElementById('textAnswer');
        if(textInput) textInput.style.display = "none";
        let textBtn = document.getElementById('textNextBtn');
        if(textBtn) textBtn.style.display = "none";

    } else if (q.type === "text") {
        // Hide all MCQ buttons
        buttons.forEach(btn => btn.style.display = "none");

        let feedbackStep = document.querySelector('.step-feedback');
        let textInput = document.getElementById('textAnswer');
        let textBtn = document.getElementById('textNextBtn');

        // Create textarea if not exist
        if (!textInput) {
            textInput = document.createElement('textarea');
            textInput.id = "textAnswer";
            textInput.className = "form-control";
            textInput.placeholder = "Type your answer here";
            textInput.rows = 4;
            textInput.style.resize = "vertical";
            textInput.style.width = "100%";
            feedbackStep.appendChild(textInput);
        }

        textInput.style.display = "block";
        textInput.value = ""; // clear previous input

        // Create button if not exist
        if (!textBtn) {
            textBtn = document.createElement('button');
            textBtn.id = "textNextBtn";
            textBtn.className = "submit-btn";
            textBtn.style.marginTop = "10px";
            feedbackStep.appendChild(textBtn);
        }

        textBtn.style.display = "inline-block";
        textBtn.innerText = currentStep === questions.length - 1 ? "Submit" : "Next »";

        // Always assign onclick handler
        textBtn.onclick = selectTextAnswer;
    }

    // Update progress bar
    let progress = (currentStep / questions.length) * 100;
    let green = Math.floor(progress * 2.55);
    let red = 255 - green;
    let progressBar = document.getElementById('progressBar');
    progressBar.style.width = progress + "%";
    progressBar.style.backgroundColor = `rgb(${red},${green},0)`;
}

// Handle text answer input and submission - **NEW FUNCTION**
function selectTextAnswer() {
    let textInput = document.getElementById('textAnswer');
    let answer = textInput.value.trim();

    if (!answer) {
        alert("Please provide your answer before proceeding.");
        return;
    }
    
    // Save the answer
    let qKey = `q${currentStep + 1}`;
    answers[qKey] = answer;

    // Move to the next step or submit
    currentStep++;
    if (currentStep < questions.length) {
        showQuestion(); 
    } else {
        submitFeedback(); // This correctly calls submit on the final question
    }
}


// Handle MCQ answer (The version with the delay)
function selectAnswer(optionIndex) {
    let qKey = `q${currentStep+1}`;
    answers[qKey] = questions[currentStep].options[optionIndex];

    // Highlight selected button
    let buttons = document.querySelectorAll('.option-btn');
    buttons.forEach((btn, i) => {
        if (i === optionIndex) {
            btn.classList.add("selected");
        } else {
            btn.classList.remove("selected");
        }
    });

    // Small delay so user sees the selection
    setTimeout(() => {
        currentStep++;
        if (currentStep < questions.length) {
            showQuestion(); // resets buttons for next question
        } else {
            submitFeedback();
        }
    }, 150); // 150ms delay
}


// Submit final answers
function submitFeedback() {
    let questionText = document.getElementById('questionText');
    let progressBar = document.getElementById('progressBar');
    
    // --- 1. UI LOCK & LOADING STATE ---
    
    // Max out progress bar
    progressBar.style.width = "100%";
    progressBar.style.backgroundColor = "green";
    
    // Hide buttons/text area and show submission message
    questionText.innerText = "Submitting Feedback... Please wait. ";
    document.querySelectorAll('.option-btn').forEach(btn => btn.style.display = "none");
    
    let textInput = document.getElementById('textAnswer');
    if (textInput) textInput.style.display = "none";
    let textBtn = document.getElementById('textNextBtn');
    if (textBtn) textBtn.style.display = "none";
    
    // --- 2. Perform Submission ---
    
    fetch("/submit_feedback", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(answers)
    }).then(res => res.json())
      .then(data => {
          // --- 3. Handle Response ---
          if(data.status === "success"){
              // Success: Redirect to the thank you page
              window.location.href = data.redirect;
          } else {
              // Error: Show alert and revert UI state
              alert("Error submitting feedback: " + data.message);
              
              // Re-display the last question/step for retry
              currentStep = questions.length - 1; 
              showQuestion(); 
          }
      })
      .catch(err => {
          // Network Error: Show alert and revert UI state
          alert("Network error: Could not connect to the server.");
          
          // Re-display the last question/step for retry
          currentStep = questions.length - 1; 
          showQuestion();
      });
}
</script>
</body>
</html>
